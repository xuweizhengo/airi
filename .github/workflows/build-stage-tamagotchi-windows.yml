name: Build Stage Tamagotchi Windows (Tauri)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: true
        type: boolean

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        run_install: false

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    # ç¼“å­˜ Cargo ä¾èµ–
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    # ç¼“å­˜ç¼–è¯‘çš„ target ç›®å½•
    - name: Cache cargo target
      uses: actions/cache@v3
      with:
        path: |
          apps/stage-tamagotchi/src-tauri/target
        key: ${{ runner.os }}-cargo-target-tauri-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-target-tauri-

    # ç¼“å­˜ node_modules
    - name: Cache node_modules
      uses: actions/cache@v3
      with:
        path: |
          node_modules
          ~/.pnpm-store
        key: ${{ runner.os }}-node-modules-${{ hashFiles('pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-node-modules-

    - name: Install dependencies
      run: |
        pnpm install --frozen-lockfile

    - name: Build workspace packages
      run: |
        pnpm run build:packages

    - name: Build Tauri application
      working-directory: apps/stage-tamagotchi
      run: |
        pnpm run app:build
      env:
        CARGO_INCREMENTAL: 1
        RUST_LOG: info
        RUST_BACKTRACE: '1'

    - name: Package build files
      shell: powershell
      run: |
        $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
        $packageName = "stage-tamagotchi-windows-$timestamp"
        New-Item -ItemType Directory -Path $packageName -Force

        # å¤åˆ¶ Tauri æ„å»ºè¾“å‡ºæ–‡ä»¶
        $sourcePaths = @(
          "apps/stage-tamagotchi/src-tauri/target/release/bundle/nsis/*.exe",
          "apps/stage-tamagotchi/src-tauri/target/release/bundle/msi/*.msi",
          "apps/stage-tamagotchi/src-tauri/target/release/*.exe"
        )

        foreach ($path in $sourcePaths) {
          if (Test-Path $path) {
            Copy-Item $path $packageName/ -Force -ErrorAction SilentlyContinue
          }
        }

        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        @"
        ğŸ‰ Stage Tamagotchi (Tauri) Windowsç‰ˆæœ¬ - GitHub Actionsæ„å»º

        æ„å»ºä¿¡æ¯:
        - æ„å»ºæ—¶é—´: $(Get-Date)
        - æ„å»ºæ¥æº: GitHub Actions
        - åˆ†æ”¯/æ ‡ç­¾: $env:GITHUB_REF_NAME
        - æäº¤å“ˆå¸Œ: $env:GITHUB_SHA
        - æ„å»ºID: $env:GITHUB_RUN_ID
        - Nodeç‰ˆæœ¬: $(node --version)
        - pnpmç‰ˆæœ¬: $(pnpm --version)
        - Rustç‰ˆæœ¬: $(rustc --version)

        æŠ€æœ¯æ ˆ:
        - æ¡†æ¶: Tauri (Rust + Vue)
        - æ‰“åŒ…æ ¼å¼: NSIS/MSI

        ä½¿ç”¨æ–¹æ³•:
        1. ä¸‹è½½å¹¶è§£å‹æ–‡ä»¶åŒ…
        2. è¿è¡Œ .exe å®‰è£…ç¨‹åº
        3. æˆ–è€…ç›´æ¥è¿è¡Œ AIRI.exe (å¦‚æœæœ‰ä¾¿æºç‰ˆ)
        "@  | Out-File -FilePath "$packageName/BUILD_INFO.txt" -Encoding UTF8

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @'
        @echo off
        title Stage Tamagotchi (Tauri) - GitHub Actionsæ„å»ºç‰ˆ
        echo ===============================================
        echo ğŸ‰ Stage Tamagotchi (Tauri) - GitHub Actionsæ„å»º
        echo ===============================================
        echo.
        echo âœ… è¿™æ˜¯åŸºäº Tauri çš„ Windows ç‰ˆæœ¬
        echo âœ… ä»GitHub Actionsè‡ªåŠ¨æ„å»º
        echo.
        echo ğŸš€ è¯·è¿è¡Œå®‰è£…ç¨‹åºè¿›è¡Œå®‰è£…...
        echo.
        pause
        '@ | Out-File -FilePath "$packageName/install-instructions.bat" -Encoding ASCII

        # æ‰“åŒ…
        Compress-Archive -Path $packageName -DestinationPath "$packageName.zip" -Force

        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_ENV
        echo "PACKAGE_ZIP=$packageName.zip" >> $env:GITHUB_ENV

        # æ˜¾ç¤ºæ„å»ºç»“æœ
        echo "ğŸ“¦ æ„å»ºåŒ…åˆ›å»ºå®Œæˆ: $packageName.zip"
        Get-ChildItem $packageName | Format-Table Name, Length, LastWriteTime

    - name: Upload build artifacts
      if: ${{ inputs.upload_artifacts != false }}
      uses: actions/upload-artifact@v4
      with:
        name: stage-tamagotchi-windows-${{ github.run_id }}
        path: ${{ env.PACKAGE_ZIP }}
        retention-days: 30

    - name: Create Release (ä»…åœ¨æ‰“ tag æ—¶)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.PACKAGE_ZIP }}
        body: |
          ## Stage Tamagotchi (Tauri) Windowsç‰ˆæœ¬

          ### ä¸‹è½½è¯´æ˜
          - ğŸ“¦ Windowsç‰ˆæœ¬: `${{ env.PACKAGE_ZIP }}`

          ### å®‰è£…è¯´æ˜
          1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
          2. è¿è¡Œå®‰è£…ç¨‹åº (.exe æˆ– .msi)
          3. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…

          ### æŠ€æœ¯æ ˆ
          - åŸºäº Tauri æ¡†æ¶ (Rust + Vue)
          - æ›´å°çš„ä½“ç§¯ï¼Œæ›´å¿«çš„å¯åŠ¨é€Ÿåº¦
          - åŸç”Ÿ Windows æ€§èƒ½

          ### æ›´æ–°å†…å®¹
          - æŸ¥çœ‹æœ€è¿‘çš„æäº¤è®°å½•äº†è§£æ›´æ–°å†…å®¹

          ---
          ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ